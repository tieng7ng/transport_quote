# Mapping par défaut des colonnes
# Le système normalise les headers (minuscules, sans accents, sans espaces)
# et cherche des correspondances ici.

default:
  columns:
    transport_mode: ["mode", "transport", "type", "mode_transport"]
    origin_city: ["ville_depart", "origin_city", "city_from", "depart", "ville_enlèvement", "origine"]
    origin_country: ["pays_depart", "origin_country", "country_from", "pays_enlèvement", "iso_depart", "pays", "pays_origine"]
    origin_postal_code: ["cp_depart", "zip_from", "postal_code_from", "code_postal_depart"]
    dest_city: ["ville_arrivee", "dest_city", "city_to", "arrivee", "ville_livraison", "destination"]
    dest_country: ["pays_arrivee", "dest_country", "country_to", "pays_livraison", "iso_arrivee", "pays_dest"]
    dest_postal_code: ["cp_arrivee", "zip_to", "postal_code_to", "code_postal_arrivee"]
    weight_min: ["poids_min", "weight_min", "min_kg", "kg_min"]
    weight_max: ["poids_max", "weight_max", "max_kg", "kg_max"]
    volume_min: ["volume_min", "min_m3"]
    volume_max: ["volume_max", "max_m3"]
    cost: ["prix", "price", "montant", "cost", "tarif", "net"]
    currency: ["devise", "currency"]
    delivery_time: ["delai", "delivery_time", "transit_time", "temps"]
    valid_until: ["validite", "valid_until", "date_fin", "expiration"]

# Configurations spécifiques par Partenaire (Code Partenaire)
partners:
  DHL:
    columns:
      cost: "Tarif 2024"

  # Configuration pour Transport BESSON (Matrix/Grid)
  # Fichier: grille tarifaire2024 BESSON.xlsx
  BESSON: # Utiliser le CODE du partenaire ici (ex: "BESSON" ou "TEST_IMPORT" si on teste avec celui-là)
    layout: "grid"
    header_row: 0 # Ligne 1 dans Excel (0-indexed)
    sheet_name: "Tarifs" # Optionnel, pour cibler une feuille précise
    columns:
      origin_city: "Agence"
      origin_postal_code: "Agence"
      dest_postal_code: "Département" # ex: "01"
      zone: "Zone" # ex: "1"
      dest_city: "unnamed:_3" # Colonne sans header mapee vers ville destination
    
    defaults:
      transport_mode: "ROAD"
      origin_country: "FR"
      dest_country: "FR"
      currency: "EUR"
    
    grid:
      pivot_axis: "weight"
      value_column: "cost"
      header_regex: "^(\\d+)[_\\s]*(KG|kg)" # Match "5 KG", "5_KG", "5kg", "5_kg"
      unit: "KG"
      weight_min_gap: 1  # Tranches disjointes: 0-5, 6-10, 11-20, etc.

    transforms:
      origin_city:
        NIC: "NICE"
        MAR: "MARSEILLE"
      origin_postal_code:
        NIC: "06"
        MAR: "13"

  # Configuration pour BIANCHI (Dual Matrix)
  # Fichier: ML BIANCHI GROUP PROTOCOLE...
  BIANCHI:
    layout: "dual_grid"
    header_row: 6
    sheet_name: "PROTOCOLE DISTRIBUTION FRANCE"
    
    columns:
      dest_postal_code: "zip_code"     # Section 1 & 2 (fusionné si possible, mais colonne 1 prioritaire)
      # Les colonnes spécifiques pour le mapping sont définies dans dual_grid ci-dessous ou via alias direct
      pricing_type_small: "pricing"
      delivery_time_small: "t/t_from_nice_**"
      pricing_type_large: "pricing.1"     # Pandas suffix .1 pour le doublon (Section 2)
      delivery_time_large: "t/t_from_nice_**.1"

    defaults:
      transport_mode: "ROAD"
      origin_country: "FR"
      origin_city: "NICE"
      origin_postal_code: "06000"
      dest_country: "FR"
      dest_city: "ALL"  # Tarif par département, pas par ville spécifique
      currency: "EUR"

    # Transformation de valeurs spécifiques
    transforms:
      dest_postal_code:
        "20 (1)": "2A"
        "20 (2)": "2B"
        "98": "98000"
      pricing_type:
        "PRICE PER 100KGS": "PER_100KG"
        "PRICE PER 100KGS ": "PER_100KG"  # Avec espace trailing
        "LUMPSUM FROM NICE": "LUMPSUM"

    dual_grid:
      small_weights:
        columns:
          "Minimum": { weight_min: 0, weight_max: 99 }
          "100/300 kg": { weight_min: 100, weight_max: 300 }
          "301/500kg": { weight_min: 301, weight_max: 500 }
          "501/1000 kg": { weight_min: 501, weight_max: 1000 }
        pricing_col: "pricing_type_small"
        delivery_time_col: "delivery_time_small"
      
      large_weights:
        columns:
          "1001/1500 kg": { weight_min: 1001, weight_max: 1500 }
          "1501/2000 kg": { weight_min: 1501, weight_max: 2000 }
          "2001/3000 kg": { weight_min: 2001, weight_max: 3000 }
          "3001/4000 kg": { weight_min: 3001, weight_max: 4000 }
          "4001/5000 kg": { weight_min: 4001, weight_max: 5000 }
        pricing_col: "pricing_type_large"
        delivery_time_col: "delivery_time_large"

  # ══════════════════════════════════════════════════════════════════════════════
  # Configuration MONACO LOGISTIQUE (Multi-Sheet)
  # Fichier: PROTOCOLLO NT-MonacoLogistique Ott 2020 - agg.to 01.01.2023.xlsx
  # Un seul partenaire, plusieurs feuilles traitées en un seul import
  # ══════════════════════════════════════════════════════════════════════════════
  MONACO_LOG:
    layout: "multi_sheet"

    sheets:
      # ────────────────────────────────────────────────────────────────────────
      # Feuille 1 : Tarifs France (Nice → Départements FR)
      # ────────────────────────────────────────────────────────────────────────
      - name: "france"
        sheet_name: "1-Tarifs MonacoLog"
        header_row: 15
        layout: "dual_grid"

        columns:
          # Noms normalisés (minuscules, underscores)
          dest_postal_code: "zip_code"
          pricing_type_small: "pricing"
          delivery_time_small: "t/t_from_nice_**"
          pricing_type_large: "pricing.1"
          delivery_time_large: "t/t_from_nice_**.1"

        defaults:
          transport_mode: "ROAD"
          origin_country: "FR"
          origin_city: "NICE"
          origin_postal_code: "06000"
          dest_country: "FR"
          dest_city: "ALL"
          currency: "EUR"

        transforms:
          dest_postal_code:
            "20 (1)": "2A"
            "20 (2)": "2B"
            "98": "98000"
          pricing_type:
            "PRICE PER 100KGS": "PER_100KG"
            "PRICE PER 100KGS ": "PER_100KG"
            "LUMPSUM FROM NICE": "LUMPSUM"

        dual_grid:
          small_weights:
            columns:
              # Noms normalisés correspondant aux headers Excel
              "minimum": { weight_min: 0, weight_max: 99 }
              "100/300_kg": { weight_min: 100, weight_max: 300 }
              "301/500kg": { weight_min: 301, weight_max: 500 }
              "501/1000_kg": { weight_min: 501, weight_max: 1000 }
            pricing_col: "pricing_type_small"
            delivery_time_col: "delivery_time_small"
          large_weights:
            columns:
              "1001/1500_kg": { weight_min: 1001, weight_max: 1500 }
              "1501/2000_kg": { weight_min: 1501, weight_max: 2000 }
              "2001/3000_kg": { weight_min: 2001, weight_max: 3000 }
              "3001/4000_kg": { weight_min: 3001, weight_max: 4000 }
              "4001/5000_kg": { weight_min: 4001, weight_max: 5000 }
            pricing_col: "pricing_type_large"
            delivery_time_col: "delivery_time_large"

      # ────────────────────────────────────────────────────────────────────────
      # Feuille 2 : Tarifs Italie (Melzo → Provinces IT)
      # ────────────────────────────────────────────────────────────────────────
      - name: "italy"
        sheet_name: "2.TARIFS NT"
        header_row: 21
        layout: "single_grid"

        columns:
          dest_postal_code: "unnamed:_1"

        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "IT"
          currency: "EUR"

        transforms:
          dest_postal_code:
            regex_extract: "^(\\d+)"

        single_grid:
          province_column: "unnamed:_1"
          brackets:
            # Noms normalisés correspondant aux headers Excel
            - header: "minimum"
              weight_min: 0
              weight_max: 99
              pricing_type: "LUMPSUM"
            - header: "till_500_kgs"
              weight_min: 100
              weight_max: 500
              pricing_type: "PER_100KG"
            - header: "501_–_1000"
              weight_min: 501
              weight_max: 1000
              pricing_type: "PER_100KG"
            - header: "1001_–_2000"
              weight_min: 1001
              weight_max: 2000
              pricing_type: "PER_100KG"
            - header: "2001_–_2500"
              weight_min: 2001
              weight_max: 2500
              pricing_type: "PER_100KG"
            - header: "2501_–_3000"
              weight_min: 2501
              weight_max: 3000
              pricing_type: "PER_100KG"

      # ────────────────────────────────────────────────────────────────────────
      # Feuille 3 : Tarifs Slovénie (3.rates SI)
      # ────────────────────────────────────────────────────────────────────────
      - name: "slovenia"
        sheet_name: "3.rates SI"
        header_row: 11
        layout: "zone_matrix"
        columns: {}
        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "SI"
          dest_city: "ALL"
          currency: "EUR"
        zone_matrix:
          weight_column: "KG"

      # ────────────────────────────────────────────────────────────────────────
      # Feuille 4 : Tarifs Serbie (4.rates XS)
      # ────────────────────────────────────────────────────────────────────────
      - name: "serbia"
        sheet_name: "4.rates XS"
        header_row: 10
        layout: "zone_matrix"
        columns: {}
        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "RS"
          dest_city: "ALL"
          currency: "EUR"
        zone_matrix:
          weight_column: "Kg"
          zone_to_postcodes:
            "A": ["110", "111", "112", "220", "223", "224"]
            "B": ["113", "114", "115", "142", "143", "150", "152", "153", "210", "211", "212", "222", "260", "262"]
            "C": ["120", "122", "123", "140", "214", "230", "243", "263", "343", "2521", "2522", "2523", "2524", "2525", "3420", "3421", "3422"]
            "D": ["233", "240", "241", "242", "244", "250", "320", "322", "323", "340", "350", "352", "2526", "2527", "2528", "3125", "3126", "3423", "3424"]
            "E": ["310", "360", "361", "362", "370", "3120", "3121", "3122", "3123", "3124"]
            "F": ["180", "182", "184", "192", "363", "372", "3131", "3133"]
            "G": ["160", "162", "190", "193", "3130", "3132"]
            "H": ["170", "175", "181", "183"]

      # ────────────────────────────────────────────────────────────────────────
      # Feuille 5 : Tarifs Croatie (5.rates HR)
      # ────────────────────────────────────────────────────────────────────────
      - name: "croatia"
        sheet_name: "5.rates HR"
        header_row: 9
        layout: "zone_matrix"
        columns: {}
        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "HR"
          dest_city: "ALL"
          currency: "EUR"
        zone_matrix:
          weight_column: "Kg"
          # Codes postaux = préfixes (ex: 10000 -> 10...)
          zone_to_postcodes:
            "A": ["10000"]
            "B": ["10290", "10340", "10370", "10410", "10430"]
            "C": ["42000", "42240", "43000", "44000", "44310", "44320", "47000", "49000", "49210"]
            "D": ["33000", "33520", "40000", "48000"]
            "E": ["31000", "31400", "32000", "32100", "32270", "34000", "35000", "51000", "51300", "53000", "53220", "53270"]
            "F": ["21000", "21260", "21300", "22000", "22320", "52000", "52210", "52440", "52470"]
            "G": ["20000", "20340", "20350"]

      # ────────────────────────────────────────────────────────────────────────
      # Feuille 6 : Tarifs Portugal (6.rates PT)
      # ────────────────────────────────────────────────────────────────────────
      - name: "portugal"
        sheet_name: "6.rates PT"
        header_row: 9
        layout: "zone_matrix"
        columns: {}
        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "PT"
          dest_city: "ALL"
          currency: "EUR"
        zone_matrix:
          weight_column: "Kg"
      
      # ────────────────────────────────────────────────────────────────────────
      # Feuille 7 : Tarifs Grèce (7-rates GR-ADReNON)
      # ────────────────────────────────────────────────────────────────────────
      - name: "greece"
        sheet_name: "7-rates GR-ADReNON"
        header_row: 9
        layout: "zone_matrix"
        columns: {}
        defaults:
          transport_mode: "ROAD"
          origin_country: "IT"
          origin_city: "MELZO"
          origin_postal_code: "20066"
          dest_country: "GR"
          dest_city: "ALL"
          currency: "EUR"
        zone_matrix:
          weight_column: "Kg"

  # ══════════════════════════════════════════════════════════════════════════════
  # Configurations legacy (conservées pour rétrocompatibilité)
  # ══════════════════════════════════════════════════════════════════════════════

  # Configuration pour MONACO LOGISTIQUE - FRANCE (Nice -> Départements FR)
  # Fichier: PROTOCOLLO NT-MonacoLogistique... Feuille 1
  MONACO_LOG_FR:
    layout: "dual_grid"
    header_row: 14
    sheet_name: "1-Tarifs MonacoLog"

    columns:
      dest_postal_code: "zip code"
      pricing_type_small: "PRICING"
      delivery_time_small: "T/T from Nice **"
      pricing_type_large: "PRICING.1"
      delivery_time_large: "T/T from Nice **.1"

    defaults:
      transport_mode: "ROAD"
      origin_country: "FR"
      origin_city: "NICE"
      origin_postal_code: "06000"
      dest_country: "FR"
      dest_city: "ALL"
      currency: "EUR"

    transforms:
      dest_postal_code:
        "20 (1)": "2A"
        "20 (2)": "2B"
        "98": "98000"
      pricing_type:
        "PRICE PER 100KGS": "PER_100KG"
        "LUMPSUM FROM NICE": "LUMPSUM"

    dual_grid:
      small_weights:
        columns:
          "Minimum": { weight_min: 0, weight_max: 99 }
          "100/300 kg": { weight_min: 100, weight_max: 300 }
          "301/500kg": { weight_min: 301, weight_max: 500 }
          "501/1000 kg": { weight_min: 501, weight_max: 1000 }
        pricing_col: "pricing_type_small"
        delivery_time_col: "delivery_time_small"

      large_weights:
        columns:
          "1001/1500 kg": { weight_min: 1001, weight_max: 1500 }
          "1501/2000 kg": { weight_min: 1501, weight_max: 2000 }
          "2001/3000 kg": { weight_min: 2001, weight_max: 3000 }
          "3001/4000 kg": { weight_min: 3001, weight_max: 4000 }
          "4001/5000 kg": { weight_min: 4001, weight_max: 5000 }
        pricing_col: "pricing_type_large"
        delivery_time_col: "delivery_time_large"

  # Configuration pour MONACO LOGISTIQUE - ITALIE (Melzo -> Provinces IT)
  # Fichier: PROTOCOLLO NT-MonacoLogistique... Feuille 2
  MONACO_LOG_IT:
    layout: "single_grid" # Nouvelle layout spécifique ou adaptation de 'grid'
    header_row: 20
    sheet_name: "2.TARIFS NT"

    columns:
      dest_province: 1  # Index colonne B (0-based = 1) - Sera géré par parser/mapper si supporté ou via nom
      # Mapping via noms de colonnes (si headers présents ligne 21)
      # Les headers sont : "PROVINCES", "Minimum", "Till 500 kgs", "501 – 1000", "1001 – 2000", "2001 – 2500", "2501 – 3000"
      dest_postal_code: "PROVINCES" 

    defaults:
      transport_mode: "ROAD"
      origin_country: "IT"
      origin_city: "MELZO"
      origin_postal_code: "20066"
      dest_country: "IT"
      currency: "EUR"
    
    # Configuration spéciale pour extraire le code province de "20 Milano"
    transforms:
      dest_postal_code:
        regex_extract: "^(\\d+)" # Pour extraire "20" de "20 Milano"

    grid:
      pivot_axis: "weight"
      value_column: "cost"
      # Regex pour matcher les colonnes de poids qui ne sont pas standard "XX KG"
      # Headers: "Minimum", "Till 500 kgs", "501 – 1000", ...
      # On va devoir adapter le ColumnMapper pour supporter une liste explicite de colonnes pivot
      # OU utiliser une regex flexible.
      # Utilisons une approche explicite via 'weight_brackets' qui sera implémentée dans single_grid
    
    single_grid:
      province_column: "PROVINCES"
      brackets:
        - header: "Minimum"
          weight_min: 0
          weight_max: 99
          pricing_type: "LUMPSUM"
        - header: "Till 500 kgs"
          weight_min: 100
          weight_max: 500
          pricing_type: "PER_100KG"
        - header: "501 – 1000"
          weight_min: 501
          weight_max: 1000
          pricing_type: "PER_100KG"
        - header: "1001 – 2000"
          weight_min: 1001
          weight_max: 2000
          pricing_type: "PER_100KG"
        - header: "2001 – 2500"
          weight_min: 2001
          weight_max: 2500
          pricing_type: "PER_100KG"
        - header: "2501 – 3000"
          weight_min: 2501
          weight_max: 3000
          pricing_type: "PER_100KG"
